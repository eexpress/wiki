# LVM

> ç¬¬ä¸€æ¬¡åŠ¨lvmã€‚æ¸…é™¤ä¸€ä¸ªç©ºé—²ç©ºé—´å‡ºæ¥ï¼Œå°±æ˜¯ç¬¬7åˆ†åŒºï¼Œæ ¼å¼åŒ–æˆext4ï¼ˆä¸æ ¼å¼åŒ–çš„è¯ï¼Œä¸çŸ¥é“pvå‘½ä»¤è®¤ä¸è®¤ï¼‰ã€‚

## æ¸…ç†å‡ºç©ºé—²ç¬¬7åˆ†åŒºï¼Œäº§ç”Ÿç‰©ç†å·ã€‚/ç›®å‰37Gã€‚
```
# pvcreate /dev/nvme0n1p7
WARNING: ext4 signature detected on /dev/nvme0n1p7 at offset 1080. Wipe it? [y/n]: y
  Wiping ext4 signature on /dev/nvme0n1p7.
  Physical volume "/dev/nvme0n1p7" successfully created.

# pvs
  PV             VG       Fmt  Attr PSize  PFree 
  /dev/nvme0n1p5 fedora00 lvm2 a--  37.46g <3.85g   <--è€æ ¹
  /dev/nvme0n1p7 fedora00 lvm2 a--  15.85g 15.85g   <--æ–°å¢
```
## ç¬¬7åˆ†åŒºåŠ å…¥fedora00å·ç»„
```
# vgextend fedora00 /dev/nvme0n1p7
  Volume group "fedora00" successfully extended

# vgs
  VG       #PV #LV #SN Attr   VSize  VFree  
  fedora00   2   1   0 wz--n- 53.31g <19.70g    <--å·ç»„æœ‰ç©ºä½™äº†
```
## å¢åŠ rooté€»è¾‘å·
```
# lvresize -L +18G /dev/fedora00/root 
  Size of logical volume fedora00/root changed from 33.61 GiB (8605 extents) to 51.61 GiB (13213 extents).
  Logical volume fedora00/root successfully resized.
# pvs
  PV             VG       Fmt  Attr PSize  PFree 
  /dev/nvme0n1p5 fedora00 lvm2 a--  37.46g     0    <--ç”¨å®Œ
  /dev/nvme0n1p7 fedora00 lvm2 a--  15.85g <1.70g   <--å‰©ä¸‹
# vgs
  VG       #PV #LV #SN Attr   VSize  VFree 
  fedora00   2   1   0 wz--n- 53.31g <1.70g     <--å·ç»„ä½¿ç”¨äº†
# lvs
  LV   VG       Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root fedora00 -wi-ao---- 51.61g   <--rooté€»è¾‘å·å¢åŠ 
```
## çœŸæ­£ä¿®æ”¹rooté€»è¾‘å·çš„æŒ‚è½½å°ºå¯¸
```
# resize2fs -f /dev/mapper/fedora00-root 
resize2fs 1.44.4 (18-Aug-2018)
/dev/mapper/fedora00-root ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿå·²è¢«æŒ‚è½½äº /ï¼›éœ€è¦è¿›è¡Œåœ¨çº¿è°ƒæ•´å¤§å°

old_desc_blocks = 5, new_desc_blocks = 7
/dev/mapper/fedora00-root ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿç°åœ¨ä¸º 13530112 ä¸ªå—ï¼ˆæ¯å— 4kï¼‰ã€‚
# df -h|grep root
/dev/mapper/fedora00-root   51G   22G   27G   45% /     <--æ ¹åˆ†åŒºæ­£å¼å¢åŠ 
# lvscan
  ACTIVE            '/dev/fedora00/root' [51.61 GiB] inherit
```

---

# æ¢å¤swap

> æ‰‹è´±åˆ é™¤äº†swapåˆ†åŒºï¼ˆä¹‹å‰æŒ‚åœ¨fedora00-swapçš„LVä¸Šé¢ï¼‰

```
# lvremove /dev/fedora00/swap 
Do you really want to remove active logical volume fedora00/swap? [y/n]: y
  Logical volume "swap" successfully removed
```
> è¯¯åˆ é™¤äº†è¿™ä¸ªåˆ†åŒºã€‚å¯åŠ¨çš„æ—¶å€™ï¼Œä¸€ç›´è¦ä»è¿™é‡Œæ¢å¤ä¼‘çœ æ•°æ®ï¼ˆçœ‹æ—¥å¿—æ‰å‘ç°æ˜¯vmlinuzå‚æ•°æŒ‡å®šçš„ï¼‰ã€‚å¹²è„†åˆ é™¤ã€‚è®©6åˆ†åŒºç›´æ¥å½“swapã€‚ä¿®æ”¹äº†fstabã€‚

> å¯åŠ¨è¿˜æ˜¯å¡ä½ï¼Œä¸€ç›´è¦ä»fedora00-swapæ¢å¤æ•°æ®ã€‚

## ç³»ç»Ÿæ—¥å¿—

```
# cat /run/initramfs/rdsosreport.txt |grep resume
\\vmlinuz-4.20.12-200.fc29.x86_64 root=/dev/mapper/fedora00-root ro resume=/dev/mapper/fedora00-swap rd.lvm.lv=fedora00/root rd.lvm.lv=fedora/swap rd.lvm.lv=fedora00/swap rhgb quiet LANG=zh_CN.UTF-8 rd.driver.blacklist=nouveau modprobe.blacklist=nouveau nvidia-drm.modeset=1 initrd=\initramfs-4.20.12-200.fc29.x86_64.img
......
[   92.069923] eexpss-r720 systemd[1]: systemd-hibernate-resume@dev-mapper-fedora00\x2dswap.service: Job systemd-hibernate-resume@dev-mapper-fedora00\x2dswap.service/start failed with result 'dependency'.
# cat /run/initramfs/rdsosreport.txt |grep Fail
[    3.579733] eexpss-r720 dracut-initqueue[463]: Failed to find logical volume "fedora00/swap"

```
## è¿˜æ˜¯æ¢å¤ç¬¬6åˆ†åŒºï¼ŒåŠ åˆ°swapé€»è¾‘å·
```
# swapon -s
æ–‡ä»¶å				ç±»å‹		å¤§å°	å·²ç”¨	æƒé™
/dev/nvme0n1p6                         	partition	3854332	0	-2
# swapoff -a
# fdisk -l /dev/nvme0n1p6
Disk /dev/nvme0n1p6ï¼š3.7 GiBï¼Œ3946840064 å­—èŠ‚ï¼Œ7708672 ä¸ªæ‰‡åŒº
å•å…ƒï¼šæ‰‡åŒº / 1 * 512 = 512 å­—èŠ‚
æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚
I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚
# pvcreate /dev/nvme0n1p6
WARNING: swap signature detected on /dev/nvme0n1p6 at offset 4086. Wipe it? [y/n]: y
  Wiping swap signature on /dev/nvme0n1p6.
  Physical volume "/dev/nvme0n1p6" successfully created.
# vgextend fedora00 /dev/nvme0n1p6
# pvscan
  PV /dev/nvme0n1p5   VG fedora00        lvm2 [37.46 GiB / 0    free]
  PV /dev/nvme0n1p7   VG fedora00        lvm2 [15.85 GiB / <1.70 GiB free]
  PV /dev/nvme0n1p6   VG fedora00        lvm2 [3.67 GiB / 3.67 GiB free]
  Total: 3 [56.98 GiB] / in use: 3 [56.98 GiB] / in no VG: 0 [0   ]
# lvcreate -L 3.6G -n swap fedora00 
  Rounding up size to full physical extent 3.60 GiB
  Logical volume "swap" created.
# lvs
  LV   VG       Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root fedora00 -wi-ao---- 51.61g                                                    
  swap fedora00 -wi-a-----  3.60g
# gvim /etc/fstab   <--æ¢å¤ä»¥å‰çš„æŒ‚è½½
# mkswap /dev/fedora00/swap 
æ­£åœ¨è®¾ç½®äº¤æ¢ç©ºé—´ç‰ˆæœ¬ 1ï¼Œå¤§å° = 3.6 GiB (3867144192  ä¸ªå­—èŠ‚)
æ— æ ‡ç­¾ï¼ŒUUID=45099d56-2419-4e38-8d36-3ccfe1839d4a
# swapon -a     <--æŒ‰ç…§fstabæŒ‚è½½
# swapon -s
æ–‡ä»¶å				ç±»å‹		å¤§å°	å·²ç”¨	æƒé™
/dev/dm-1                              	partition	3776508	0	-2
# lsblk
NAME              MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda                 8:0    0 931.5G  0 disk 
â”œâ”€sda1              8:1    0   128M  0 part 
â”œâ”€sda2              8:2    0 833.7G  0 part 
â””â”€sda3              8:3    0  97.7G  0 part 
nvme0n1           259:0    0 119.2G  0 disk 
â”œâ”€nvme0n1p1       259:1    0   260M  0 part /boot/efi
â”œâ”€nvme0n1p2       259:2    0    16M  0 part 
â”œâ”€nvme0n1p3       259:3    0    60G  0 part 
â”œâ”€nvme0n1p4       259:4    0     1G  0 part /boot
â”œâ”€nvme0n1p5       259:5    0  37.5G  0 part 
â”‚ â””â”€fedora00-root 253:0    0  51.6G  0 lvm  /
â”œâ”€nvme0n1p6       259:6    0   3.7G  0 part 
â”‚ â””â”€fedora00-swap 253:1    0   3.6G  0 lvm  [SWAP]
â”œâ”€nvme0n1p7       259:7    0  15.9G  0 part 
â”‚ â””â”€fedora00-root 253:0    0  51.6G  0 lvm  /
â””â”€nvme0n1p8       259:8    0  1000M  0 part 
```
> å¯åŠ¨ä»ç„¶å¡ä½ï¼Œè¿›æ•‘æ´æ¨¡å¼ï¼Œè¿˜æ˜¯æç¤ºæ‰¾ä¸åˆ° /dev/fedora/swap

```
# cat /proc/cmdline
\\vmlinuz-4.20.12-200.fc29.x86_64 root=/dev/mapper/fedora00-root ro resume=/dev/mapper/fedora00-swap rd.lvm.lv=fedora00/root rd.lvm.lv=fedora/swap rd.lvm.lv=fedora00/swap rhgb quiet LANG=zh_CN.UTF-8 rd.driver.blacklist=nouveau modprobe.blacklist=nouveau nvidia-drm.modeset=1 initrd=\initramfs-4.20.12-200.fc29.x86_64.img
# cd /boot/efi/EFI/fedora/
# grep initramfs-4.20.12-200.fc29.x86_64.img *
grep: fonts: Is a directory
grub.cfg:	initrdefi /initramfs-4.20.12-200.fc29.x86_64.img
<-- æ‰¾åˆ°è¿™è¡Œï¼Œåˆ é™¤ä¸Šæ–¹çš„ rd.lvm.lv=fedora/swap
```
> è¦ä¸å°±åˆ é™¤å¯åŠ¨å‚æ•°â€œrd.lvm.lv=fedora/swapâ€ï¼›è¦ä¸å°±æ¢å¤/dev/fedora/swap

> é‡åˆ°ä¸€ä¸ªä¸€æ ·çš„é—®é¢˜ã€‚ä»–å»æ‰è¿™å¥å°±å¯ä»¥äº†ã€‚https://superuser.com/questions/1324097/change-default-swap-disk-in-centos7

> å®‰è£…äº†grub-customizerï¼Œçœ‹åˆ°çš„ä¸€è¡Œå†…å®¹çš„æ˜¾ç¤ºæ¬¡åºå’Œ /boot/efi/EFI/fedora/grub.cfg æœ‰å·®å¼‚ã€‚å¯¹æ¯”ä¿®æ”¹ï¼Œlinuxefiéƒ½å˜æˆlinuxäº†ã€‚ä¸çŸ¥é“æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œè¿˜æ˜¯å•¥ã€‚åæ­£ç»“æœè¿˜æ˜¯æ— æ•ˆã€‚

## é‡å»ºinitramfs
```
# mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
# dracut -v /boot/initramfs-$(uname -r).img $(uname -r)
```
> æ²¡æ•ˆæœã€‚
```
# gvim /etc/default/grub
# grub2-mkconfig -o grub.cfg    <--åŒæ—¶ä¿®æ”¹
```
> æ²¡æ•ˆæœã€‚

```
# grep fedora/swap /etc/default/grub
# grep fedora/swap /boot/efi/EFI/fedora/grub.cfg 
# grep fedora/swap /proc/cmdline
\\vmlinuz-4.20.12-200.fc29.x86_64 root=/dev/mapper/fedora00-root ro resume=/dev/mapper/fedora00-swap rd.lvm.lv=fedora00/root rd.lvm.lv=fedora/swap rd.lvm.lv=fedora00/swap rhgb quiet LANG=zh_CN.UTF-8 rd.driver.blacklist=nouveau modprobe.blacklist=nouveau nvidia-drm.modeset=1 initrd=\initramfs-4.20.12-200.fc29.x86_64.img
```
> ä¸¢åˆ°supersuå»äº†ã€‚

---

> @lilydjwg: refind å®ƒè‡ªå·±ä¸æ˜¯ loader å—ï¼Ÿ

> è¢« lilydjwg ç‚¹é†’äº†ã€‚ä¹‹å‰å°±grepè¿‡æ•´ä¸ª`/boot/efi/EFI/refind/`ï¼Œæ²¡æ‰¾åˆ°â€œfedora/swapâ€ï¼Œä»¥ä¸º refind åªç®¡å¯åŠ¨ efiæ–‡ä»¶ã€‚ä»Šå¤©æ‰¾refindå®‰è£…çš„binæ–‡ä»¶ï¼Œä¸€ä¸ªä¸€ä¸ªçœ‹helpï¼Œçœ‹ç€mkrlconfè¿™å¦–å­½åƒé‡å»ºé…ç½®çš„ã€‚ä¸€è¡Œåˆ·æ–°äº†é…ç½®ï¼Œæ¢å¤æ­£å¸¸ã€‚ <-- ç¬¬äºŒå¤©èµ·åºŠæ—¶åˆ†ã€‚

```
ğŸ”´ mkrlconf --force
```
